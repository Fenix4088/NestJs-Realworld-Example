<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Chat Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            background: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 600px;
            padding: 20px;
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-weight: bold;
        }
        .status.connected {
            background: #d4edda;
            color: #155724;
        }
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        #messages {
            border: 1px solid #ddd;
            height: 400px;
            overflow-y: auto;
            padding: 15px;
            margin-bottom: 15px;
            background: #fafafa;
            border-radius: 5px;
        }
        .message {
            margin-bottom: 10px;
            padding: 8px;
            background: white;
            border-radius: 5px;
            border-left: 3px solid #007bff;
        }
        .message.system {
            background: #fff3cd;
            border-left-color: #ffc107;
        }
        .message.own {
            background: #d1ecf1;
            border-left-color: #17a2b8;
        }
        .message-meta {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        .message-text {
            color: #333;
        }
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .typing {
            font-style: italic;
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üí¨ WebSocket Chat Test</h1>
        
        <div id="status" class="status disconnected">
            üî¥ –û—Ç–∫–ª—é—á–µ–Ω–æ
        </div>

        <div class="input-group">
            <input 
                type="text" 
                id="username" 
                placeholder="–í–∞—à–µ –∏–º—è" 
                value="User_<?= rand(1000, 9999) ?>"
            />
        </div>

        <div id="typing" class="typing"></div>

        <div id="messages"></div>

        <div class="input-group">
            <input 
                type="text" 
                id="messageInput" 
                placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                disabled
            />
            <button id="sendBtn" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>

        <div style="margin-top: 15px; font-size: 12px; color: #666;">
            <strong>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ:</strong> ws://localhost:3000<br>
            <strong>Client ID:</strong> <span id="clientId">-</span>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const statusEl = document.getElementById('status');
        const messagesEl = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const usernameInput = document.getElementById('username');
        const clientIdEl = document.getElementById('clientId');
        const typingEl = document.getElementById('typing');

        let socket;
        let typingTimeout;

        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket —Å–µ—Ä–≤–µ—Ä—É
        function connect() {
            socket = io('http://localhost:3000', {
                transports: ['websocket'],
                auth: {
                    token: `${localStorage.getItem('jwt')}`
                }
            });

            // –°–æ–±—ã—Ç–∏–µ: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
            socket.on('connect', () => {
                console.log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É');
                statusEl.className = 'status connected';
                statusEl.textContent = 'üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                clientIdEl.textContent = socket.id;
                messageInput.disabled = false;
                sendBtn.disabled = false;
            });

            // –°–æ–±—ã—Ç–∏–µ: –û—Ç–∫–ª—é—á–µ–Ω–∏–µ
            socket.on('disconnect', () => {
                console.log('‚ùå –û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
                statusEl.className = 'status disconnected';
                statusEl.textContent = 'üî¥ –û—Ç–∫–ª—é—á–µ–Ω–æ';
                messageInput.disabled = true;
                sendBtn.disabled = true;
            });

            // –°–æ–±—ã—Ç–∏–µ: –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
            socket.on('welcome', (data) => {
                addMessage('system', '–°–∏—Å—Ç–µ–º–∞', data.message);
            });

            // –°–æ–±—ã—Ç–∏–µ: –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è
            socket.on('user-joined', (data) => {
                addMessage('system', '–°–∏—Å—Ç–µ–º–∞', `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${data.clientId} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è`);
            });

            // –°–æ–±—ã—Ç–∏–µ: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—à–µ–ª
            socket.on('user-left', (data) => {
                addMessage('system', '–°–∏—Å—Ç–µ–º–∞', `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${data.clientId} –≤—ã—à–µ–ª`);
            });

            // –°–æ–±—ã—Ç–∏–µ: –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
            socket.on('message', (data) => {
                const isOwn = data.clientId === socket.id;
                addMessage(
                    isOwn ? 'own' : 'other',
                    data.username,
                    data.text,
                    new Date(data.timestamp)
                );
            });

            // –°–æ–±—ã—Ç–∏–µ: –ö—Ç–æ-—Ç–æ –ø–µ—á–∞—Ç–∞–µ—Ç
            socket.on('user-typing', (data) => {
                typingEl.textContent = `${data.username} –ø–µ—á–∞—Ç–∞–µ—Ç...`;
                clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => {
                    typingEl.textContent = '';
                }, 3000);
            });
        }

        // –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        function sendMessage() {
            const text = messageInput.value.trim();
            const username = usernameInput.value.trim() || 'Anonymous';

            if (text && socket && socket.connected) {
                socket.emit('message', { text, username }, (response) => {
                    console.log('–û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response);
                });
                messageInput.value = '';
            }
        }

        // –î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
        function addMessage(type, username, text, timestamp = new Date()) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const time = timestamp.toLocaleTimeString('ru-RU');
            
            messageDiv.innerHTML = `
                <div class="message-meta">
                    <strong>${username}</strong> ¬∑ ${time}
                </div>
                <div class="message-text">${text}</div>
            `;
            
            messagesEl.appendChild(messageDiv);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ "typing" —Å–æ–±—ã—Ç–∏—è
        messageInput.addEventListener('input', () => {
            if (socket && socket.connected) {
                socket.emit('typing', {
                    username: usernameInput.value.trim() || 'Anonymous'
                });
            }
        });

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–µ
        sendBtn.addEventListener('click', sendMessage);

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Enter
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        connect();
    </script>
</body>
</html>